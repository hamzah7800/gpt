<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Client-Side AI Engine (JS/ML Tools)</title>
    <link rel="icon" href="icon-192.jpg" type="image/jpeg">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>
    <script src="https://docs.opencv.org/4.x/opencv.js" async onload="window.cv=cv"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    
    <style>
        /* Custom scrollbar styles */
        .chat-list::-webkit-scrollbar, .chat-interface::-webkit-scrollbar, #chatBox::-webkit-scrollbar {
            width: 8px;
        }
        .chat-list::-webkit-scrollbar-thumb, #chatBox::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        .chat-list::-webkit-scrollbar-track, #chatBox::-webkit-scrollbar-track {
            background-color: #e2e8f0; /* slate-200 */
        }

        /* NProgress customization */
        #nprogress .bar {
            background: #2563eb !important; /* Blue-600 */
            height: 3px !important;
        }
        #nprogress .peg {
            box-shadow: 0 0 10px #2563eb, 0 0 5px #2563eb !important;
        }

        /* --- General Styling --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- Animation & Transition Styles --- */
        .thinking-message { background-color: #fff8e1; color: #ff9800; border: 1px solid #ffcc80; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        .dot { opacity: 0; animation: dot-fade 1s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dot-fade { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
        
        /* Tool Card Styles (Color coding the function calls) */
        .tool-card { padding: 0.75rem; margin-bottom: 0rem; border-radius: 0.5rem; transition: background-color 0.3s; }
        .tool-card-math { background-color: #e0f7fa; border: 1px solid #00bcd4; color: #006064; }
        .tool-card-rag { background-color: #e8f5e9; border: 1px solid #4caf50; color: #1b5e20; }
        .tool-card-vision { background-color: #fce4ec; border: 1px solid #e91e63; color: #880e4f; }
        .tool-card-ml { background-color: #f3e8ff; border: 1px solid #9333ea; color: #5b21b6; }
        .tool-card-generation { background-color: #e3f2fd; border: 1px solid #2196f3; color: #0d47a1; }
        .tool-card-code { background-color: #f3e5f5; border: 1px solid #9c27b0; color: #4a148c; }
        .tool-card-api { background-color: #fffde7; border: 1px solid #ffeb3b; color: #f57f17; }
        .tool-card-vis { background-color: #fff3e0; border: 1px solid #ff9800; color: #e65100; }
        .tool-card-3d { background-color: #f0fdf4; border: 1px solid #10b981; color: #065f46; }
        .tool-card-fallback { background-color: #ffebee; border: 1px solid #f44336; color: #b71c1c; }


        .response-content { margin-top: 0.5rem; }

        .voice-recording { background-color: #ef4444; animation: voice-pulse 1s infinite alternate; }
        @keyframes voice-pulse { from { opacity: 1; } to { opacity: 0.7; } }

        @media (max-width: 1024px) { 
            .sidebar { position: absolute; z-index: 20; height: 100%; transform: translateX(-100%); transition: transform 0.3s ease; }
            #gameSection.sidebar-visible .sidebar { transform: translateX(0); }
            #sidebarToggle { display: block !important; }
            .chat-interface { overflow: hidden; }
        }
        
        /* D3 Tooltip CSS */
        .tooltip { 
            position: absolute; text-align: center; padding: 8px; font: 10px sans-serif; 
            background: lightsteelblue; border: 0px; border-radius: 8px; pointer-events: none; 
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">

    <div id="loginContainer" class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-sm text-center">
        <h1 class="text-3xl text-blue-600 font-bold mb-6">Client-Side AI Engine Access</h1>
        <p class="text-gray-600 mb-4">Login to access the simulator.</p>
        <input type="text" id="username_login" placeholder="Username (ryzen)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        <input type="password" id="password_login" placeholder="Key (4060)" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        <button onclick="validateLogin()" class="w-full p-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200">Login</button>
        <div id="error-message" class="text-red-600 font-bold mt-4"></div>
    </div>

    <div id="gameSection" class="hidden bg-white rounded-xl shadow-2xl w-full max-w-7xl h-[95vh] max-h-[800px] overflow-hidden flex transition-all duration-300">
        
        <div class="sidebar bg-gray-800 text-white w-64 flex-shrink-0 flex flex-col border-r border-gray-700">
            <h2 class="px-5 pt-5 text-lg font-semibold border-b border-gray-700 pb-3 mb-4">Chat History</h2>
            <button class="new-chat-btn mx-5 mb-4 p-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition" onclick="startNewChat()">+ New Chat</button>
            <ul class="chat-list list-none p-0 m-0 flex-grow overflow-y-auto">
                </ul>
            <div class="p-4 border-t border-gray-700">
                <p class="text-sm text-gray-400">Powered by client-side JS libraries.</p>
            </div>
        </div>

        <div class="chat-interface flex-grow flex flex-col relative">
            
            <div id="dropZone" tabindex="-1" class="absolute inset-0 bg-purple-600 bg-opacity-80 text-white hidden justify-center items-center text-2xl z-10 pointer-events-none">Drop Image for ML Classification (TensorFlow.js)</div>

            <div id="dataPanel" class="d3-panel-hidden absolute inset-0 bg-white p-5 z-20 overflow-y-auto transition-opacity duration-300">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Client-Side Data Explorer (D3.js)</h3>
                <button onclick="toggleDataPanel()" class="absolute top-5 right-5 p-2 bg-red-500 text-white rounded-full text-sm font-semibold hover:bg-red-600 z-30">
                    &times; Close
                </button>
                
                <div class="flex flex-col lg:flex-row gap-6">
                    
                    <div class="lg:w-1/2 bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h4 class="text-xl font-semibold mb-3">D3.js Scatter Plot: Feature Correlation</h4>
                        <div id="d3ChartArea" style="width: 100%; height: 350px;">
                            </div>
                        <p class="text-sm text-gray-500 mt-2">Visualization rendered by D3.js on the client.</p>
                    </div>

                    <div class="lg:w-1/2">
                        <h4 class="text-xl font-semibold mb-3">Raw Simulated Data (JSON)</h4>
                        <div class="bg-gray-800 text-green-400 p-3 rounded-lg overflow-x-auto text-sm h-[400px]">
                            <pre id="dataJsonView"></pre>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h4 class="text-xl font-semibold mb-3">Simulated Data Description</h4>
                    <p class="text-gray-700">This panel demonstrates client-side data processing and visualization using **D3.js**. The data simulates performance metrics (**Latency** vs. **Throughput**) for a client-side ML model over time, with point color indicating **Accuracy**.</p>
                </div>
            </div>

            <div class="chat-header bg-gray-50 p-4 border-b border-gray-200 flex items-center">
                <button id="sidebarToggle" onclick="toggleSidebar()" class="text-xl text-blue-600 mr-4 hidden">&#9776;</button>
                <img src="icon-192.jpg" alt="AI Icon" class="header-icon w-8 h-8 rounded-full object-cover mr-4 border-2 border-500">
                <h3 class="text-lg font-semibold text-gray-800" id="current-chat-title">AI Engine (Gemini-Style Dispatch Active)</h3>
            </div>

            <div id="chatBox" class="flex-grow p-5 overflow-y-auto bg-gray-50 flex flex-col space-y-4">
                </div>

            <div class="input-container p-4 border-t border-gray-200 flex items-center bg-white">
                <input type="text" id="userInput" placeholder="Ask a question, run a calculation, or drag an image..." autocomplete="off" class="flex-grow p-3 border border-gray-300 rounded-full mr-2 text-base focus:ring-blue-500 focus:border-blue-500">
                
                <button id="dataPanelToggle" class="input-btn bg-purple-600 text-white w-10 h-10 rounded-full text-xl flex justify-center items-center hover:bg-purple-700 transition ml-2" onclick="toggleDataPanel()" title="Open Data Explorer (D3.js)">üìä</button>
                <button id="voiceBtn" class="input-btn bg-blue-600 text-white w-10 h-10 rounded-full text-xl flex justify-center items-center hover:bg-blue-700 transition ml-2" onclick="toggleVoiceInput()">üé§</button>
                <button id="sendBtn" class="input-btn bg-blue-600 text-white w-10 h-10 rounded-full text-xl flex justify-center items-center hover:bg-blue-700 transition ml-2" onclick="sendMessage()">&#9658;</button>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL STATE VARIABLES
        let lastResponse = '';
        let lastResponseType = 'none';
        let currentSessionId = 'session_' + Date.now();
        const HISTORY_ROOT_KEY = 'CLIENT_AI_CHAT_HISTORY';
        let chatContext = [];
        const mathScope = {};
        let isVoiceRecording = false;
        let recognition = null;
        
        // ML Model State
        let mobilenetModel = null;
        
        // UI Element References
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const chatList = document.querySelector('.chat-list');
        const voiceBtn = document.getElementById('voiceBtn');
        const sendBtn = document.getElementById('sendBtn');
        const dropZone = document.getElementById('dropZone');


// ---------------------------
// 1. INITIALIZATION & SETUP
// ---------------------------

        window.validateLogin = function() {
            const username = document.getElementById("username_login").value.trim();
            const password = document.getElementById("password_login").value.trim();
            const errorMessage = document.getElementById("error-message");

            if (username === "ryzen" && password === "4060") {
                document.getElementById("loginContainer").style.display = "none";
                const gameSection = document.getElementById("gameSection");
                gameSection.classList.remove('hidden');
                gameSection.classList.add('flex');

                NProgress.start();
                // Simulate model initialization time
                setTimeout(() => {
                    NProgress.done();
                    initializeChatbotUI();
                }, 500);
            } else {
                errorMessage.textContent = "Invalid username or password. Try again.";
            }
        }
        
        async function initializeChatbotUI() {
            try {
                if (window.mobilenet && window.tf) {
                    mobilenetModel = await mobilenet.load();
                    console.log("TensorFlow.js MobileNet Model Loaded Successfully.");
                } else {
                    console.warn("TensorFlow.js or MobileNet not loaded. ML Vision will be simulated.");
                }
            } catch (e) {
                console.error("Error loading MobileNet model:", e);
            }

            if (sendBtn) sendBtn.addEventListener('click', () => window.sendMessage());
            if (userInput) userInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') window.sendMessage();
            });
            document.querySelector('.new-chat-btn').addEventListener('click', window.startNewChat);
            document.getElementById('sidebarToggle').addEventListener('click', window.toggleSidebar);
            window.setupDragAndDrop();
            
            const sessions = window.loadHistory();
            if (Object.keys(sessions).length === 0) {
                window.startNewChat();
            } else {
                // Load the most recent session
                currentSessionId = Object.keys(sessions).sort().pop();
                window.renderSidebar(sessions);
                window.renderChatBox(sessions[currentSessionId]);
            }
            userInput.focus();
        }

        window.toggleSidebar = function() {
            document.getElementById('gameSection').classList.toggle('sidebar-visible');
        }

// ---------------------------
// 2. CHAT HISTORY & RENDERING
// ---------------------------

        window.loadHistory = function() {
            try {
                const history = localStorage.getItem(HISTORY_ROOT_KEY);
                return history ? JSON.parse(history) : {};
            } catch (e) {
                console.error("Error loading chat history from localStorage", e);
                return {};
            }
        }

        window.saveHistory = function(sessions) {
            try {
                localStorage.setItem(HISTORY_ROOT_KEY, JSON.stringify(sessions));
            } catch (e) {
                console.error("Error saving chat history to localStorage", e);
            }
        }

        window.saveCurrentChat = function(userContent, botContent) {
            const sessions = window.loadHistory();
            if (!sessions[currentSessionId]) {
                sessions[currentSessionId] = { title: "New Chat", messages: [] };
            }

            if (userContent) {
                sessions[currentSessionId].messages.push({ sender: 'user', content: userContent });
                // Simple title update based on first user message
                if (sessions[currentSessionId].title === "New Chat") {
                    sessions[currentSessionId].title = userContent.substring(0, 30).trim() + (userContent.length > 30 ? '...' : '');
                    document.getElementById('current-chat-title').textContent = sessions[currentSessionId].title;
                }
            }
            if (botContent) {
                sessions[currentSessionId].messages.push({ sender: 'ai', content: botContent });
            }

            window.saveHistory(sessions);
        }

        window.renderChatBox = function(session) {
            chatBox.innerHTML = '';
            if (!session) return;
            session.messages.forEach(msg => {
                if (msg.sender === 'user') {
                    window.appendUserMessage(msg.content, false);
                } else {
                    // Bot messages contain the tool card HTML, which appendBotMessage handles
                    window.appendBotMessage(msg.content, false, 'history', true);
                }
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            document.getElementById('current-chat-title').textContent = session.title;
        }

        window.renderSidebar = function(sessions) {
            chatList.innerHTML = '';
            const sessionIds = Object.keys(sessions).sort().reverse(); 

            sessionIds.forEach(id => {
                const session = sessions[id];
                const isActive = id === currentSessionId;
                const li = document.createElement('li');
                
                li.innerHTML = `
                    <div class="flex items-center justify-between p-3 text-sm rounded-lg cursor-pointer ${isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-700 text-gray-300'}">
                        <span class="truncate" onclick="window.loadChat('${id}')" style="flex-grow: 1;">${session.title}</span>
                        <button onclick="window.deleteChat('${id}')" class="ml-2 text-xs font-bold text-red-400 hover:text-red-300 transition-colors">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
                chatList.appendChild(li);
            });
        }

        window.loadChat = function(id) {
            currentSessionId = id;
            const sessions = window.loadHistory();
            window.renderChatBox(sessions[id]);
            window.renderSidebar(sessions);
        }

        window.deleteChat = function(id) {
            if (!confirm("Are you sure you want to delete this chat session?")) return;
            
            const sessions = window.loadHistory();
            delete sessions[id];
            window.saveHistory(sessions);

            if (id === currentSessionId) {
                window.startNewChat();
            } else {
                window.renderSidebar(sessions);
            }
        }

        window.startNewChat = function() {
            currentSessionId = 'session_' + Date.now();
            const initialMessage = window.formatToolResponse(`Hello! I'm a **Client-Side AI Engine**. I operate using a **Gemini-style function call dispatch** to execute local tools: **Math.js** (calculations), **MobileNet** (image analysis), **Plotly** (visualizations), and **Three.js/Cannon.js** (physics simulations).`, 'generation_mock');
            
            chatBox.innerHTML = '';
            window.appendBotMessage(initialMessage, true, 'history', false);
            
            window.saveCurrentChat(null, initialMessage);
            document.getElementById('current-chat-title').textContent = "New Chat";
            window.renderSidebar(window.loadHistory());
        }


        window.appendUserMessage = function(text, save = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'justify-end');
            messageDiv.innerHTML = `
                <div class="bg-blue-600 text-white p-3 rounded-lg shadow max-w-2xl">
                    <p class="font-semibold mb-1">You</p>
                    <p class="whitespace-pre-wrap">${text}</p>
                </div>
            `;
            chatBox.appendChild(messageDiv);
            if (save) window.saveCurrentChat(text, null);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        /**
         * Appends or replaces the bot's message, handling tool cards and markdown.
         */
        window.appendBotMessage = function(htmlContent, save = true, toolType = 'fallback', append = true) {
            // Escape tool card from markdown rendering
            let contentForRendering = htmlContent;
            const toolCardMatch = htmlContent.match(/<div class="tool-card.*?<\/div>/s);
            let toolCardHtml = '';
            if (toolCardMatch) {
                toolCardHtml = toolCardMatch[0];
                contentForRendering = htmlContent.replace(toolCardMatch[0], '');
            }

            const finalContent = contentForRendering
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code class="bg-gray-100 p-1 rounded">$1</code>')
                .replace(//g, toolCardHtml); // Put card back

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'justify-start');
            messageDiv.innerHTML = `
                <div class="bg-white p-3 rounded-lg shadow max-w-3xl flex-grow">
                    <p class="font-semibold text-gray-800 mb-1">AI Assistant</p>
                    <div class="text-gray-700 space-y-3">${finalContent}</div>
                </div>
            `;

            if (save) window.saveCurrentChat(null, htmlContent);

            if (append) {
                chatBox.appendChild(messageDiv);
            } else {
                const thinkingDiv = document.getElementById('thinking-message-container');
                if (thinkingDiv) {
                    thinkingDiv.replaceWith(messageDiv);
                } else {
                    chatBox.appendChild(messageDiv);
                }
            }
            
            if (window.renderMathInElement) {
                renderMathInElement(messageDiv);
            }

            chatBox.scrollTop = chatBox.scrollHeight;
            return messageDiv;
        }

        window.appendBotThinking = function(message) {
            const existingThinking = document.getElementById('thinking-message-container');
            if (existingThinking) existingThinking.remove();
            
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinking-message-container'; 
            thinkingDiv.classList.add('flex', 'justify-start');
            thinkingDiv.innerHTML = `
                <div id="thinking-message" class="bg-white p-3 rounded-lg shadow max-w-xs thinking-message">
                    <p class="font-semibold text-gray-800 mb-1">AI Assistant</p>
                    <p class="text-gray-600">${message} <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></p>
                </div>
            `;
            chatBox.appendChild(thinkingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return thinkingDiv;
        }

// ---------------------------
// 3. VOICE INPUT
// ---------------------------

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                voiceBtn.disabled = true;
                voiceBtn.title = "Voice input not supported in this browser.";
                console.warn("Web Speech API not supported.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = function() {
                isVoiceRecording = true;
                voiceBtn.classList.add('voice-recording');
                voiceBtn.innerHTML = 'üî¥';
                userInput.placeholder = "Listening... speak now...";
            };

            recognition.onresult = function(event) {
                const finalTranscript = event.results[0][0].transcript;
                userInput.value = finalTranscript;
                window.stopVoiceInput(false);
                window.sendMessage(); 
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                let errorMessage = "Could not capture voice.";
                if (event.error === 'not-allowed') {
                    errorMessage = "Microphone access denied. Check your browser settings.";
                }
                alert(errorMessage);
                window.stopVoiceInput(false);
            };

            recognition.onend = function() {
                if (isVoiceRecording) window.stopVoiceInput(false);
            };
        }

        window.stopVoiceInput = function(manual = true) {
            if (recognition && isVoiceRecording) {
                if (manual) recognition.stop();
                isVoiceRecording = false;
                voiceBtn.classList.remove('voice-recording');
                voiceBtn.innerHTML = 'üé§';
                userInput.placeholder = "Ask a question, run a calculation, or drag an image...";
            }
        }

        window.toggleVoiceInput = function() {
            if (!recognition) setupSpeechRecognition();

            if (isVoiceRecording) {
                window.stopVoiceInput(true);
            } else if (recognition) {
                try {
                    recognition.start();
                } catch (e) {
                    console.warn("Recognition start failed, likely already running or permission issue.");
                }
            }
        }

// ---------------------------
// 4. CORE CHATBOT LOGIC (Gemini-Style Dispatch)
// ---------------------------

        const KNOWLEDGE_BASE = [
            { keywords: ['html', 'what html', 'define html', 'html stands for'], response: "**HTML** (HyperText Markup Language) forms the **structure** of web pages." },
            { keywords: ['javascript', 'what is javascript', 'js'], response: "**JavaScript** is the programming language that enables **interactive web pages**." },
            { keywords: ['llm', 'what is llm', 'large language model', 'ai'], response: "A **Large Language Model (LLM)** is a type of AI that understands and generates human-like text, typically operating on a massive number of parameters." },
            { keywords: ['tensorflow', 'tfjs', 'machine learning', 'client-side ai'], response: "**TensorFlow.js** is the powerful library that enables running **Machine Learning models** directly in the browser using JavaScript." },
            { keywords: ['d3.js', 'what is d3'], response: "**D3.js** is a JavaScript library for creating custom data visualizations using HTML, SVG, and CSS, ideal for dynamic charting." },
            { keywords: ['plotly', 'scientific charts'], response: "**Plotly.js** is an excellent tool for declarative scientific, statistical, and 3D data visualization rendered in the browser." },
            { keywords: ['css', 'what is css'], response: "**CSS** (Cascading Style Sheets) defines the presentation and style of a document written in HTML." },
            { keywords: ['webassembly', 'wasm'], response: "**WebAssembly (Wasm)** is a low-level bytecode format for high-performance applications on the web, often used for heavy computations like video processing or complex client-side AI." },
        ];

        /**
         * Central "Gemini Nano" style function for tool dispatching.
         */
        window.gemini_style_dispatch = async function(query, fileDataUrl, fileDetails) {
            query = query.toLowerCase();
            
            // --- 1. Tool-Call Intent Matching (Priority Order) ---

            // 1a. Real-time ML Tool (Highest priority when file dropped)
            if (fileDataUrl && mobilenetModel) {
                return { tool: 'clientSideML', args: [fileDataUrl, fileDetails] };
            }

            // 1b. 3D/Physics Simulation Tool
            if (query.includes('simulate') || query.includes('physics') || query.includes('3d') || query.includes('falling') || query.includes('cube') || query.includes('sphere')) {
                return { tool: 'clientSide3DSimulation', args: [query] };
            }

            // 1c. Visualization Tool
            if (query.includes('plot') || query.includes('chart') || query.includes('graph') || query.includes('visualize') || query.includes('data')) {
                return { tool: 'clientSideVisualization', args: [query] };
            }
            
            // 1d. Math Tool 
            const mathRegex = /^(calculate|solve|what is|compute|evaluate|integrate|differentiate|find the|log|sin|cos|tan|sqrt|!|\^|\*\*|\/|%|\*|\+|[0-9])/i;
            if (mathRegex.test(query) && !query.includes('what is the meaning of')) {
                return { tool: 'clientSideMath', args: [query] };
            }
            
            // 1e. Code Execution 
            if (query.includes('run code') || query.includes('execute') || query.includes('write a script')) {
                return { tool: 'clientSideCodeExecutionMock', args: [query] };
            }

            // 1f. Image Generation 
            if (query.includes('generate image') || query.includes('create a picture') || query.includes('draw me')) {
                return { tool: 'clientSideImageGenerationMock', args: [query] };
            }

            // 1g. Live Search
            if (query.includes('latest news') || query.includes('what is the current') || query.includes('weather') || query.includes('stock price') || query.includes('today')) {
                return { tool: 'clientSideAPIMock', args: [query] };
            }

            // 1h. Keyword/RAG Tool 
            for (const item of KNOWLEDGE_BASE) {
                if (item.keywords.some(k => query.includes(k))) {
                    return { tool: 'getKeywordResponse', args: [query, chatContext] };
                }
            }
            
            // 1i. Essay Generator 
            if (query.length > 20) {
                return { tool: 'clientSideEssayGenerator', args: [query] };
            }

            // 1j. Vision Tool (Fallback for ML if model fails or simulated)
            if (fileDetails) {
                return { tool: 'clientSideVisionMock', args: [fileDetails] };
            }

            // 1k. Fallback
            return { tool: 'getFallbackResponse', args: [query] };
        }


        window.sendMessage = async function(fileDataUrl = null, fileDetails = null) {
            NProgress.start();
            const userText = userInput.value.trim();
            if (!userText && !fileDataUrl) {
                NProgress.done();
                return;
            }

            // 1. Append User Message & Disable Input
            if (userText) window.appendUserMessage(userText);
            
            userInput.value = '';
            userInput.disabled = true;
            sendBtn.disabled = true;
            voiceBtn.disabled = true;
            document.getElementById('dataPanelToggle').disabled = true;

            // 2. Add to context
            let query = userText || (fileDetails ? `Analyze the image: ${fileDetails.name}` : '');
            if (userText) {
                chatContext.push(userText);
                if (chatContext.length > 3) chatContext.shift();
            }
            
            // 3. AI Reasoning (Thinking Message)
            const thinkingDiv = window.appendBotThinking('Simulating AI inference: Analyzing query and selecting function call...');
            
            // 4. Dispatch Tool Call
            const dispatch = await window.gemini_style_dispatch(query, fileDataUrl, fileDetails);
            
            let finalResponse = '';
            lastResponseType = dispatch.tool.replace(/clientSide|get|Mock|Response|ML/g, '').toLowerCase(); // e.g., 'clientSideMath' -> 'math'
            
            // 5. Simulate Tool Execution and Response
            await new Promise(r => setTimeout(r, 500)); // Simulate tool-call latency
            
            // A. Show the Tool Call UI Card
            const toolCallCard = window.formatToolCall(dispatch.tool, dispatch.args);
            thinkingDiv.querySelector('p').innerHTML = `**Function Called:** <code>${dispatch.tool}(...)</code> <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>`; // Update thinking message
            
            // B. Execute the Tool Function
            let toolResult;
            try {
                // Ensure the function is called via the window object
                toolResult = await window[dispatch.tool].apply(null, dispatch.args);
            } catch (e) {
                toolResult = `Tool Execution Error: Could not run \`${dispatch.tool}\`. The error message was: ${e.message}`;
                lastResponseType = 'fallback';
            }

            // C. Format Final Response
            if (typeof toolResult === 'string' && toolResult.startsWith('TOOL_RESULT:')) {
                 // Direct, simple text response from a tool (e.g., Math)
                 const result = toolResult.replace('TOOL_RESULT:', '');
                 finalResponse = `${toolCallCard}\n\n**Tool Output:** The function returned an explicit result.\n\n${result}`;
            } else if (toolResult && toolResult !== 'CHART_RENDERED' && toolResult !== '3D_SIM_RENDERED' && toolResult !== 'ML_RENDERED') {
                 // Factual/Generative response (RAG/Essay/Fallback)
                 finalResponse = `${toolCallCard}\n\n**Model Generation:** The engine generated the following response after the function call:\n\n${toolResult}`;
            } else {
                // Visualization/ML tool that handled its own DOM update (no final text rendering needed)
                finalResponse = `${toolCallCard}\n\n**Tool Output:** The *${dispatch.tool.replace('clientSide', '').replace('ML', 'Vision')}* function successfully rendered its output directly in the chat box.`;
            }

            // 6. Replace Thinking Message with Final Response
            if (finalResponse) {
                window.appendBotMessage(finalResponse, true, lastResponseType, false);
            }
            
            // 7. Cleanup
            userInput.disabled = false;
            sendBtn.disabled = false;
            voiceBtn.disabled = false;
            document.getElementById('dataPanelToggle').disabled = false;
            userInput.focus();
            NProgress.done();
        }


// ---------------------------
// 5. TOOL UTIL FUNCTIONS
// ---------------------------

        /**
         * Formats a raw response string into a structured AI message with tool card.
         */
        window.formatToolResponse = function(response, type) {
            const iconMap = {
                'math': 'üßÆ', 'rag': 'üß†', 'vision_mock': 'üëÅÔ∏è', 'ml_real': 'üß†+üëÅÔ∏è', 
                'generation_mock': '‚úçÔ∏è', 'code_mock': 'üíª', 'api_mock': 'üåê', 
                'image_gen_mock': 'üé®', 'vis_real': 'üìà', '3d_real': 'üß±', 'fallback': '‚ùì'
            };
            const titleMap = {
                'math': 'Client-Side Calculation', 'rag': 'Knowledge Retrieval', 'vision_mock': 'Client-Side Vision', 
                'ml_real': 'TensorFlow.js Classification', 'generation_mock': 'Large Model Synthesis', 
                'code_mock': 'Code Execution Engine', 'api_mock': 'Live Data Search', 
                'image_gen_mock': 'Image Synthesis', 'vis_real': 'Plotly Visualization', 
                '3d_real': 'Physics Simulation', 'fallback': 'General Response'
            };
            
            const cardClass = `tool-card tool-card-${type.split('_')[0]}`;
            const toolCard = `
                <div class="${cardClass} mb-2 text-sm">
                    <p class="font-bold">${iconMap[type]} **Tool Activated:** ${titleMap[type]}</p>
                </div>
            `;

            return toolCard + response;
        }

        /**
         * Formats the explicit tool-call card to show the "Gemini-style" thought process.
         */
        window.formatToolCall = function(toolName, args) {
            const cleanName = toolName.replace('clientSide', '').replace('get', '');
            const argString = args.map(arg => typeof arg === 'string' ? `'${arg.substring(0, 30).replace(/\n/g, ' ')}...'` : '...').join(', ');
            
            // Determine the right color card for the called tool
            const toolType = toolName.replace(/clientSide|get|Mock|Response|ML/g, '').toLowerCase(); 
            const cardClass = `tool-card tool-card-${toolType.split('_')[0]}`;


            return `
                <div class="${cardClass} mb-2 text-sm">
                    <p class="font-bold text-sm text-purple-800">‚öôÔ∏è Function Call Transparently Executed</p>
                    <pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto mt-1"><code>${toolName}(${argString})</code></pre>
                    <p class="mt-1 text-gray-700">The AI engine selected this client-side function to process your request.</p>
                </div>
            `;
        }


// ---------------------------
// 6. TOOL IMPLEMENTATIONS 
// ---------------------------

        // --- 6a. Math Tool ---
        window.clientSideMath = function(query) {
            try {
                const expression = query.replace(/(calculate|solve|what is|compute|evaluate|find the)/i, '').trim();
                if (!expression) return null;

                const result = math.evaluate(expression, mathScope);
                
                if (typeof result === 'object' && result !== null) {
                    if (result.type !== 'Unit' && result.type !== 'Matrix') return null;
                }

                const formattedResult = (typeof result.toString === 'function') ? result.toString() : String(result);

                if (formattedResult && formattedResult.length < 100) {
                    const mathjaxOutput = formattedResult.includes('e') ? formattedResult : `$$${math.parse(expression).toTex()}$$ Result: **${formattedResult}**`;
                    return `TOOL_RESULT: ${window.formatToolResponse(mathjaxOutput, 'math')}`;
                }
            } catch (e) {
                return null; 
            }
            return null;
        }


        // --- 6b. RAG Tool ---
        window.getKeywordResponse = function(query, context) {
            const fullQuery = query + ' ' + context.join(' ');
            for (const item of KNOWLEDGE_BASE) {
                if (item.keywords.some(k => fullQuery.includes(k))) {
                    return window.formatToolResponse(item.response, 'rag');
                }
            }
            return null;
        }


        // --- 6c. Vision Tool (Real & Mock) ---
        window.clientSideML = async function(fileDataUrl, fileDetails) {
            const imageElement = document.createElement('img');
            imageElement.src = fileDataUrl;
            imageElement.style.maxWidth = '100%';
            imageElement.style.height = 'auto';
            imageElement.style.borderRadius = '0.5rem';
            
            try {
                window.appendBotMessage(window.formatToolResponse(`Analyzing image: **${fileDetails.name}**... `, 'ml_real'), false, 'ml_real');
                chatBox.lastChild.querySelector('.text-gray-700').appendChild(imageElement);

                const predictions = await mobilenetModel.classify(imageElement);
                const topPrediction = predictions[0];
                
                const resultText = `
                    The **TensorFlow.js MobileNet** model classified this image on your device.
                    <br><br>
                    **Top Prediction:** **${topPrediction.className}**
                    <br>
                    **Confidence:** ${(topPrediction.probability * 100).toFixed(2)}%
                `;
                
                const finalMessage = window.formatToolResponse(resultText, 'ml_real');
                window.saveCurrentChat(null, finalMessage);
                
                return 'ML_RENDERED'; 
                
            } catch (e) {
                console.error("ML Classification Error:", e);
                return window.formatToolResponse(`**Error in TensorFlow.js:** Could not classify the image. The model reported an error: ${e.message}`, 'fallback');
            }
        }

        window.clientSideVisionMock = function(fileDetails) {
            const filename = fileDetails.name.toLowerCase();
            let analysis = `A comprehensive client-side vision analysis of **${fileDetails.name}** yields: `;
            
            if (filename.includes('dog') || filename.includes('cat') || filename.includes('animal')) {
                analysis += "**Pet Mammal** with high certainty. Identified as either a Golden Retriever or Calico Cat.";
            } else if (filename.includes('graph') || filename.includes('chart') || filename.includes('data')) {
                analysis += "**Data Visualization** containing lines and axes. Predicted to show a time-series trend of computational throughput.";
            } else {
                analysis += "**Outdoor Landscape** (85% probability). Key elements: high-contrast blue sky, vibrant green foliage, and clear depth perception.";
            }

            const imageHtml = `<p>Image: **${fileDetails.name}**</p><img src="${fileDetails.dataUrl}" style="max-width: 150px; height: auto; border-radius: 5px; margin-top: 10px;">`;
            
            return window.formatToolResponse(imageHtml + '<br><br>' + analysis, 'vision_mock');
        }


        // --- 6d. Visualization Tool (Real Plotly) ---
        window.clientSideVisualization = async function(query) {
            const keywords = query.toLowerCase();
            
            if (keywords.includes('plotly') || keywords.includes('chart') || keywords.includes('visualize') || keywords.includes('data')) {
                const plotDivId = `plotly-chart-${Date.now()}`;
                const plotHtml = `<div id="${plotDivId}" style="width: 100%; height: 350px;"></div>`;
                
                const messageDiv = window.appendBotMessage(window.formatToolResponse(`**Plotly Chart Generation**... Visualization is rendering below.`, 'vis_real'), false, 'vis_real');
                messageDiv.querySelector('.text-gray-700').innerHTML += plotHtml; 

                await new Promise(r => setTimeout(r, 100)); 

                const data = [{
                    x: [1, 2, 3, 4, 5],
                    y: [1, 3, 2, 4, 5].map(y => y * (Math.random() * 0.5 + 0.75)),
                    mode: 'lines+markers',
                    type: 'scatter',
                    name: 'Performance Metric',
                    marker: {color: '#ff9800'} // Amber
                }];
                
                const layout = {
                    title: `Client-Side Generated Plot: ${query.substring(0, 50)}...`,
                    xaxis: { title: 'Time (s)' },
                    yaxis: { title: 'Metric Value' },
                    margin: { t: 40, b: 30, l: 40, r: 10 }
                };

                if (window.Plotly) {
                    Plotly.newPlot(plotDivId, data, layout, {responsive: true, displayModeBar: false});
                }
                
                window.saveCurrentChat(null, window.formatToolResponse(`**Plotly Visualization Rendered!** The client-side library executed the command and generated a Scatter Plot directly below.`, 'vis_real'));

                return 'CHART_RENDERED';
            }
            
            return null;
        }


        // --- 6e. 3D/Physics Simulation Tool (Real Three.js/Cannon.js) ---
        window.clientSide3DSimulation = async function(query) {
            const keywords = query.toLowerCase();

            if (keywords.includes('simulate') && (keywords.includes('physics') || keywords.includes('3d') || keywords.includes('falling'))) {
                
                const simDivId = `sim-canvas-${Date.now()}`;
                const simHtml = `<div id="${simDivId}" style="width: 100%; height: 300px; background-color: #333; border-radius: 0.5rem; overflow: hidden; margin-top: 10px;"></div>`;
                
                const messageDiv = window.appendBotMessage(window.formatToolResponse(`**Initializing 3D Simulation (Three.js/Cannon.js)...** A simple physics simulation of a falling object will load below.`, '3d_real'), false, '3d_real');
                messageDiv.querySelector('.text-gray-700').innerHTML += simHtml; 

                await new Promise(r => setTimeout(r, 200));

                if (window.THREE && window.CANNON) {
                    const container = document.getElementById(simDivId);
                    if (container) {
                        // Setup Three.js (omitted for brevity, assume successful setup from original code)
                        const scene = new THREE.Scene();
                        const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                        const renderer = new THREE.WebGLRenderer({ antialias: true });
                        renderer.setSize(container.clientWidth, container.clientHeight);
                        renderer.setClearColor(0x333333);
                        container.appendChild(renderer.domElement);

                        const ambientLight = new THREE.AmbientLight(0x404040); scene.add(ambientLight);
                        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                        directionalLight.position.set(1, 1, 1).normalize(); scene.add(directionalLight);

                        const world = new CANNON.World();
                        world.gravity.set(0, -9.82, 0); 

                        const groundShape = new CANNON.Plane();
                        const groundBody = new CANNON.Body({ mass: 0, shape: groundShape });
                        groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2); 
                        world.addBody(groundBody);

                        const groundGeometry = new THREE.PlaneGeometry(10, 10);
                        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 }); 
                        const groundMesh = new THREE.Mesh(groundGeometry, groundMaterial);
                        groundMesh.rotation.x = -Math.PI / 2;
                        scene.add(groundMesh);

                        const radius = 0.5;
                        const sphereShape = new CANNON.Sphere(radius);
                        const sphereBody = new CANNON.Body({ mass: 5, shape: sphereShape });
                        sphereBody.position.set(0, 5, 0);
                        world.addBody(sphereBody);

                        const sphereGeometry = new THREE.SphereGeometry(radius);
                        const sphereMaterial = new THREE.MeshLambertMaterial({ color: 0x0077ff }); 
                        const sphereMesh = new THREE.Mesh(sphereGeometry, sphereMaterial);
                        scene.add(sphereMesh);

                        camera.position.set(3, 3, 5);
                        camera.lookAt(0, 0, 0);

                        let lastTime = 0;
                        function animate(time) {
                            requestAnimationFrame(animate);

                            const dt = (time - lastTime) / 1000;
                            if (dt < 0.1) world.step(1/60, dt);
                            lastTime = time;

                            sphereMesh.position.copy(sphereBody.position);
                            sphereMesh.quaternion.copy(sphereBody.quaternion);

                            renderer.render(scene, camera);
                        }
                        
                        animate(0); 
                        
                        window.saveCurrentChat(null, window.formatToolResponse(`**3D Physics Simulation Rendered!** The client used **Three.js** and **Cannon.js** to simulate a falling sphere with real-time physics.`, '3d_real'));

                        return '3D_SIM_RENDERED';
                    }
                }
                return window.formatToolResponse(`**Error:** Three.js or Cannon.js failed to initialize the simulation.`, 'fallback');
            }
            return null;
        }


        // --- 6f. Essay Generator Tool ---
        window.clientSideEssayGenerator = function(query) {
            if (query.length > 50) {
                return window.formatToolResponse(`**Model Synthesis Report:** I have analyzed your request regarding "${query.substring(0, 35)}...". The engine generated a detailed synthesis based on its comprehensive internal model. 
                \n\n**Key Finding:** The operation of powerful AI models entirely on the client-side is becoming increasingly viable due to advancements in browser APIs (like WebGPU and WebAssembly) and optimized model architectures (like Nano). This architecture provides superior privacy, eliminates cloud costs, and enables offline functionality for tools like image classification and calculation engines, offering a more immediate and robust user experience.`, 'generation_mock');
            }
            return null;
        }

        // --- 6g. Mock Tools (Code, Image Gen, API) ---
        window.clientSideCodeExecutionMock = function(query) {
            const codeExample = `
// Input: console.log('Client AI Ready')
function performComplexCalculation(data) {
    let sum = data.reduce((a, b) => a + b, 0);
    return Math.pow(sum, 2);
}
// Simulated Output: performComplexCalculation([1, 2, 3]) -> 36
            `;
            return window.formatToolResponse(`**Code Execution Engine:** The engine interprets your command and executes the following JavaScript in a simulated environment:
                \n\n\`\`\`javascript${codeExample}\`\`\`\n\n*Note: This simulation confirms the logic. For security, actual arbitrary code execution is blocked, but the output is guaranteed to be correct for the simulated function.*`, 'code_mock');
        }

        window.clientSideImageGenerationMock = function(query) {
            const filename = `generated-asset-${Math.floor(Math.random() * 100)}.png`;
            const prompt = query.replace(/(generate image|create a picture|draw me)/i, '').trim();
            
            return window.formatToolResponse(`**Image Synthesis Tool:** Based on the prompt, "*${prompt}*", the client-side synthesis model generated a 1024x1024 asset.
                \n\n[Asset of a complex, prompt-based picture]
                \n\n**File:** *${filename}* (Simulated PNG)\n\n*This process is simulated to demonstrate capability; no file was actually created.*`, 'image_gen_mock');
        }

        window.clientSideAPIMock = function(query) {
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            return window.formatToolResponse(`**Live Data Search Tool:** The engine executed a live search for *${query}*.
                \n\n**Current Date:** ${today}
                \n\n**Simulated Data Feed:** Global **Client-Side AI Inference Latency** is averaging **32ms** (p95). The latest data suggests a 5% speed improvement year-over-year.`, 'api_mock');
        }


        // --- 6h. Fallback Tool ---
        window.getFallbackResponse = function(query) {
            return window.formatToolResponse(`I'm sorry, I couldn't dispatch a specific client-side tool to address your request: "*${query}*". Please rephrase your query to clearly indicate an action like 'calculate,' 'plot,' 'simulate,' or 'analyze image.'`, 'fallback');
        }


// ---------------------------
// 7. DRAG AND DROP
// ---------------------------
        window.setupDragAndDrop = function() {
            const gameSection = document.getElementById('gameSection');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                gameSection.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                gameSection.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                gameSection.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                dropZone.classList.remove('hidden');
                dropZone.classList.add('flex');
            }

            function unhighlight(e) {
                dropZone.classList.add('hidden');
                dropZone.classList.remove('flex');
            }

            gameSection.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                let dt = e.dataTransfer;
                let files = dt.files;

                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const file = files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const dataUrl = event.target.result;
                        const fileDetails = {
                            name: file.name,
                            type: file.type,
                            dataUrl: dataUrl
                        };
                        window.sendMessage(dataUrl, fileDetails);
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    alert('Please drop an image file.');
                }
            }
        }


// ---------------------------
// 8. D3.JS PANEL 
// ---------------------------
        window.toggleDataPanel = function() {
            const panel = document.getElementById('dataPanel');
            panel.classList.toggle('d3-panel-hidden');
            panel.classList.toggle('d3-panel-visible');

            if (panel.classList.contains('d3-panel-visible')) {
                const data = window.generateSimulatedData();
                document.getElementById('dataJsonView').textContent = JSON.stringify(data, null, 2);
                window.renderD3Chart(data);
            }
        }

        window.generateSimulatedData = function() {
            const data = [];
            const timeSteps = 50;
            for (let i = 0; i < timeSteps; i++) {
                const latency = 10 + Math.random() * 5 + Math.sin(i / 5) * 2;
                const throughput = 500 + Math.random() * 100 - Math.cos(i / 10) * 50;
                const accuracy = 0.85 + Math.random() * 0.15;
                
                data.push({
                    id: i,
                    latency: parseFloat(latency.toFixed(2)),
                    throughput: parseFloat(throughput.toFixed(2)),
                    accuracy: parseFloat(accuracy.toFixed(3))
                });
            }
            return data;
        }

        window.renderD3Chart = function(data) {
            const chartArea = document.getElementById('d3ChartArea');
            chartArea.innerHTML = ''; // Clear previous chart

            const margin = { top: 20, right: 20, bottom: 40, left: 50 };
            const width = chartArea.clientWidth - margin.left - margin.right;
            const height = chartArea.clientHeight - margin.top - margin.bottom;

            const svg = d3.select("#d3ChartArea")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain(d3.extent(data, d => d.throughput)).nice()
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain(d3.extent(data, d => d.latency)).nice()
                .range([height, 0]);
            
            const color = d3.scaleSequential(d3.interpolateViridis)
                .domain([d3.min(data, d => d.accuracy), d3.max(data, d => d.accuracy)]);

            // X-axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));
            svg.append("text")
                .attr("transform", `translate(${width / 2}, ${height + margin.bottom - 5})`)
                .style("text-anchor", "middle")
                .text("Throughput (Ops/Sec)");

            // Y-axis
            svg.append("g")
                .call(d3.axisLeft(y));
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Latency (ms)");
            
            // Tooltip
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Dots
            svg.append("g")
                .selectAll("dot")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.throughput))
                .attr("cy", d => y(d.latency))
                .attr("r", 5)
                .style("fill", d => color(d.accuracy))
                .style("opacity", 0.8)
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Acc: <strong>${(d.accuracy * 100).toFixed(1)}%</strong><br>Lat: ${d.latency}ms<br>Thr: ${d.throughput} Ops`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }


// ---------------------------
// 9. EVENT LISTENERS
// ---------------------------
        window.onload = function() {
            if (document.getElementById("loginContainer").classList.contains("hidden")) {
                initializeChatbotUI();
            }
        };

        setupSpeechRecognition();
    </script>
</body>
</html>
